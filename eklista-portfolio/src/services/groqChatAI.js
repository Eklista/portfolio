// src/services/groqChatAI.js
import { projectTypes, calculateTotalPrice, formatPrice } from '../data/pricing.js';
import { explorerStructure, projectsData } from '../data/projects.js';

class EklistaChatAI {
  constructor() {
    this.isInitialized = false;
    this.groq = null;
    this.initializeGroq();
  }

  async initializeGroq() {
    try {
      // Importaci√≥n din√°mica para evitar errores de SSR
      const { Groq } = await import('groq-sdk');
      this.groq = new Groq({
        apiKey: import.meta.env.VITE_GROQ_API_KEY,
        dangerouslyAllowBrowser: true // Para uso en frontend
      });
      this.isInitialized = true;
      console.log('‚úÖ Groq inicializado correctamente');
    } catch (error) {
      console.warn('‚ö†Ô∏è Groq no disponible, usando respuestas predefinidas');
      this.isInitialized = false;
    }
  }

  buildSystemPrompt() {
    const portfolioSummary = {
      servicios: projectTypes.map(pt => ({
        nombre: pt.name,
        descripcion: pt.description,
        precio_base: formatPrice(pt.basePrice)
      })),
      proyectos_destacados: [
        'Banking Web App - FinTech Guatemala (2024)',
        'E-commerce Platform - Fashion Forward (2024)', 
        'Restaurant Digital Experience - Sabor Aut√©ntico (2023)'
      ],
      habilidades: ['React', 'Next.js', 'WordPress', 'Figma', 'UX/UI Design'],
      ubicacion: 'Guatemala City, Guatemala',
      experiencia: '5+ a√±os, 50+ proyectos completados'
    };

    return `Eres el asistente virtual de EKLISTA, un dise√±ador web y desarrollador guatemalteco especializado en crear experiencias digitales √∫nicas.

INFORMACI√ìN DEL PORTFOLIO:
${JSON.stringify(portfolioSummary, null, 2)}

PERSONALIDAD Y TONO:
- Profesional pero cercano y amigable
- Entusiasta por la tecnolog√≠a y el dise√±o
- Responde en espa√±ol guatemalteco
- Usa emojis ocasionalmente para ser m√°s expresivo
- Enf√≥cate en generar inter√©s genuino en los servicios

REGLAS IMPORTANTES:
1. SIEMPRE menciona precios base cuando pregunten sobre costos
2. Para cotizaciones exactas, SIEMPRE invita a usar el cotizador personalizado
3. Si preguntan por proyectos espec√≠ficos, menciona casos de √©xito relevantes
4. No inventes informaci√≥n - si no sabes algo, di que pueden contactar directamente
5. Mant√©n respuestas concisas pero informativas (m√°ximo 3-4 p√°rrafos)
6. Siempre termina con una pregunta o call-to-action

EJEMPLOS DE RESPUESTAS ESPERADAS:
- Pregunta sobre precios ‚Üí Mencionar rango + invitar al cotizador
- Pregunta sobre servicios ‚Üí Explicar brevemente + mencionar tecnolog√≠as
- Pregunta sobre experiencia ‚Üí Mencionar proyectos + a√±os de experiencia
- Pregunta general ‚Üí Respuesta √∫til + redireccionar a servicios relevantes`;
  }

  // Respuestas r√°pidas para consultas comunes
  getQuickResponse(message) {
    const msg = message.toLowerCase().trim();
    
    // Saludos
    if (msg.includes('hola') || msg.includes('hello') || msg.includes('hi') || msg === 'hey') {
      return {
        isQuick: true,
        response: `¬°Hola! üëã Soy tu asistente virtual de EKLISTA.

Estoy aqu√≠ para ayudarte con:
‚Ä¢ Informaci√≥n sobre mis servicios de dise√±o y desarrollo
‚Ä¢ Precios y cotizaciones personalizadas  
‚Ä¢ Ver mi portfolio de trabajos
‚Ä¢ Resolver cualquier duda sobre tu pr√≥ximo proyecto

¬øEn qu√© puedo ayudarte hoy?`
      };
    }

    // Precios espec√≠ficos
    if (msg.includes('precio') && msg.includes('wordpress')) {
      return {
        isQuick: true,
        response: `Los sitios WordPress empiezan desde **${formatPrice(1200)}** e incluyen:

‚úÖ Dise√±o responsive y personalizado
‚úÖ Optimizaci√≥n SEO b√°sica  
‚úÖ Panel de administraci√≥n f√°cil de usar
‚úÖ Instalaci√≥n y configuraci√≥n completa

El precio final depende de las funcionalidades espec√≠ficas que necesites (tienda online, formularios avanzados, integraciones, etc.).

¬øTe gustar√≠a usar nuestro **cotizador personalizado** para obtener un presupuesto exacto en 2 minutos?`
      };
    }

    if (msg.includes('precio') && (msg.includes('ux') || msg.includes('ui') || msg.includes('dise√±o'))) {
      return {
        isQuick: true,
        response: `Los proyectos de UX/UI Design empiezan desde **${formatPrice(800)}** e incluyen:

üé® Investigaci√≥n de usuarios
üéØ Wireframes y prototipos
‚ú® Dise√±o de interfaz moderna
üì± Versi√≥n m√≥vil optimizada

Para proyectos m√°s complejos (design systems, testing de usabilidad) el precio puede aumentar seg√∫n el alcance.

¬øQuieres que calculemos el costo exacto de tu proyecto con nuestro cotizador?`
      };
    }

    // Servicios generales
    if (msg.includes('servicio') || msg.includes('qu√© haces') || msg.includes('que ofreces')) {
      return {
        isQuick: true,
        response: `Ofrezco tres servicios principales:

üíª **Desarrollo Web** (desde ${formatPrice(1200)})
‚Ä¢ Sitios WordPress personalizados
‚Ä¢ Aplicaciones React/Next.js
‚Ä¢ E-commerce y tiendas online

üé® **UX/UI Design** (desde ${formatPrice(800)})  
‚Ä¢ Investigaci√≥n de usuarios
‚Ä¢ Prototipos interactivos
‚Ä¢ Interfaces web y m√≥vil

üéØ **Dise√±o Gr√°fico** (desde ${formatPrice(500)})
‚Ä¢ Logos e identidad visual
‚Ä¢ Branding completo
‚Ä¢ Material publicitario

¬øTe interesa alg√∫n servicio en particular?`
      };
    }

    // Portfolio/proyectos
    if (msg.includes('portfolio') || msg.includes('trabajo') || msg.includes('proyecto')) {
      return {
        isQuick: true,
        response: `¬°Me encanta mostrar mi trabajo! üöÄ Algunos proyectos destacados:

üè¶ **Banking Web App** - Aplicaci√≥n financiera completa para FinTech guatemalteca
üõí **E-commerce Platform** - Tienda online que aument√≥ ventas en +250%  
üçΩÔ∏è **Restaurant Website** - Sitio con reservas que increment√≥ bookings en +400%

Para ver todos los detalles, mockups y casos de estudio, **haz doble clic en las carpetas del escritorio**. Ah√≠ encontrar√°s mi portfolio completo organizado por categor√≠as.

¬øHay alg√∫n tipo de proyecto espec√≠fico que te interese?`
      };
    }

    // Contacto
    if (msg.includes('contacto') || msg.includes('email') || msg.includes('whatsapp') || msg.includes('tel√©fono')) {
      return {
        isQuick: true,
        response: `¬°Perfecto! Aqu√≠ tienes toda mi informaci√≥n de contacto:

üìß **Email**: hello@eklista.com  
üì± **WhatsApp**: +502 1234-5678  
üíº **LinkedIn**: /in/eklista  
üìç **Ubicaci√≥n**: Guatemala City, GT

**Prefiero WhatsApp** para una respuesta m√°s r√°pida, pero cualquier canal funciona perfecto.

¬øTienes alg√∫n proyecto en mente que quieras discutir?`
      };
    }

    // Cotizaci√≥n
    if (msg.includes('cotiz') || msg.includes('presupuesto') || msg.includes('quote')) {
      return {
        isQuick: true,
        response: `¬°Excelente! üéØ Tengo un **cotizador personalizado** que te dar√° un precio exacto en solo 2 minutos.

**¬øQu√© incluye el cotizador?**
‚úÖ Selecci√≥n de tipo de proyecto  
‚úÖ Caracter√≠sticas personalizables
‚úÖ Servicios adicionales opcionales
‚úÖ Precio final instant

Solo necesitas responder unas preguntas sobre tu proyecto y tendr√°s una cotizaci√≥n detallada.

¬øEst√°s listo para empezar? Puedo abrirte el cotizador ahora mismo.`
      };
    }

    return null; // No hay respuesta r√°pida disponible
  }

  // Clasificar el tipo de consulta para mejor contexto
  classifyIntent(message) {
    const msg = message.toLowerCase();
    
    if (msg.includes('precio') || msg.includes('costo') || msg.includes('cuanto')) {
      return 'pricing';
    }
    if (msg.includes('servicio') || msg.includes('qu√© haces')) {
      return 'services';
    }
    if (msg.includes('portfolio') || msg.includes('trabajo') || msg.includes('proyecto')) {
      return 'portfolio';
    }
    if (msg.includes('contacto') || msg.includes('email') || msg.includes('whatsapp')) {
      return 'contact';
    }
    if (msg.includes('cotiz') || msg.includes('presupuesto')) {
      return 'quote';
    }
    
    return 'general';
  }

  // Respuesta principal con Groq
  async respond(userMessage) {
    try {
      // 1. Verificar respuestas r√°pidas primero
      const quickResponse = this.getQuickResponse(userMessage);
      if (quickResponse?.isQuick) {
        return {
          content: quickResponse.response,
          source: 'quick',
          success: true
        };
      }

      // 2. Si Groq no est√° disponible, usar respuestas predefinidas mejoradas
      if (!this.isInitialized || !this.groq) {
        return {
          content: this.getFallbackResponse(userMessage),
          source: 'fallback',
          success: true
        };
      }

      // 3. Usar Groq para respuestas m√°s complejas
      const intent = this.classifyIntent(userMessage);
      const systemPrompt = this.buildSystemPrompt();
      
      // A√±adir contexto espec√≠fico seg√∫n el intent
      const contextualPrompt = this.addContextForIntent(intent, systemPrompt);

      const completion = await this.groq.chat.completions.create({
        messages: [
          { role: "system", content: contextualPrompt },
          { role: "user", content: userMessage }
        ],
        model: "llama3-70b-8192", // Modelo m√°s potente
        temperature: 0.7, // Balance entre creatividad y consistencia
        max_tokens: 400,
        top_p: 0.9
      });

      const response = completion.choices[0]?.message?.content;
      
      if (!response) {
        throw new Error('No response from Groq');
      }

      return {
        content: response,
        source: 'groq',
        success: true
      };

    } catch (error) {
      console.error('Error en Groq Chat AI:', error);
      
      return {
        content: this.getFallbackResponse(userMessage),
        source: 'fallback',
        success: false,
        error: error.message
      };
    }
  }

  addContextForIntent(intent, basePrompt) {
    const contextAdditions = {
      pricing: `\nCONTEXTO ADICIONAL: El usuario est√° preguntando sobre precios. Siempre menciona los precios base y sugiere el cotizador personalizado para precios exactos.`,
      
      services: `\nCONTEXTO ADICIONAL: El usuario quiere conocer los servicios. Explica brevemente cada servicio y menciona las tecnolog√≠as clave que usas.`,
      
      portfolio: `\nCONTEXTO ADICIONAL: El usuario est√° interesado en ver trabajos. Menciona proyectos espec√≠ficos y sugiere explorar las carpetas del escritorio.`,
      
      contact: `\nCONTEXTO ADICIONAL: El usuario quiere informaci√≥n de contacto. Proporciona todos los medios y menciona preferencia por WhatsApp.`,
      
      quote: `\nCONTEXTO ADICIONAL: El usuario quiere una cotizaci√≥n. Explica el cotizador personalizado y ofrece abrirlo.`,
      
      general: ''
    };

    return basePrompt + (contextAdditions[intent] || contextAdditions.general);
  }

  // Respuesta de respaldo cuando Groq no est√° disponible
  getFallbackResponse(message) {
    const intent = this.classifyIntent(message);
    
    const fallbackResponses = {
      pricing: `Mis precios son muy competitivos para Guatemala:

üí∞ **Dise√±o Gr√°fico**: ${formatPrice(500)} - ${formatPrice(1500)}
üí∞ **Sitios WordPress**: ${formatPrice(1200)} - ${formatPrice(4000)}  
üí∞ **UX/UI Design**: ${formatPrice(800)} - ${formatPrice(2500)}
üí∞ **Desarrollo Custom**: ${formatPrice(4000)}+

Los precios var√≠an seg√∫n la complejidad del proyecto. ¬øQuieres una **cotizaci√≥n personalizada y exacta**?`,

      services: `¬°Perfecto! Te cuento sobre mis servicios principales:

üé® **Dise√±o Gr√°fico & Branding** - Desde ${formatPrice(500)}
‚Ä¢ Logos e identidad visual
‚Ä¢ Papeler√≠a corporativa  
‚Ä¢ Packaging y material promocional

üíª **Desarrollo Web** - Desde ${formatPrice(1200)}
‚Ä¢ Sitios WordPress personalizados
‚Ä¢ Aplicaciones React/Next.js
‚Ä¢ E-commerce y tiendas online

üéØ **UX/UI Design** - Desde ${formatPrice(800)}
‚Ä¢ Investigaci√≥n de usuarios
‚Ä¢ Prototipos interactivos
‚Ä¢ Interfaces web y m√≥vil

¬øTe interesa alg√∫n servicio en particular?`,

      portfolio: `¬°Excelente pregunta! üöÄ Tengo m√°s de 50 proyectos completados.

**Algunos destacados:**
‚Ä¢ Banking App UI/UX - Interfaz moderna para fintech
‚Ä¢ E-commerce Platform - Tienda completa con +250% en ventas
‚Ä¢ Restaurant Website - Sistema de reservas que aument√≥ bookings +400%

Para ver **todos los detalles, mockups y casos de estudio**, explora las carpetas del escritorio haciendo doble clic. Est√°n organizadas por categor√≠a.

¬øHay alg√∫n tipo de proyecto que te llame m√°s la atenci√≥n?`,

      contact: `¬°Perfecto! Aqu√≠ tienes toda mi informaci√≥n:

üìß **Email**: hello@eklista.com
üì± **WhatsApp**: +502 1234-5678
üíº **LinkedIn**: /in/eklista
üêô **GitHub**: @eklista
üìç **Ubicaci√≥n**: Guatemala City, GT

Prefiero **WhatsApp** para una respuesta m√°s r√°pida. ¬øCu√°l es la mejor forma de contactarte?`,

      quote: `¬°Excelente! Te voy a explicar sobre el cotizador personalizado:

‚ú® **¬øQu√© incluye?**
‚Ä¢ Selecci√≥n de tipo de proyecto
‚Ä¢ Caracter√≠sticas personalizables  
‚Ä¢ Servicios adicionales opcionales
‚Ä¢ Cotizaci√≥n instant√°nea y detallada

El cotizador te tomar√° solo **2 minutos** y tendr√°s un precio exacto al final.

¬øEst√°s listo para empezar? Puedo abrirte el cotizador ahora mismo.`,

      general: `Gracias por contactarme. Soy Pablo, tambi√©n conocido como **EKLISTA**.

Soy dise√±ador gr√°fico y desarrollador web con **5+ a√±os de experiencia** creando soluciones digitales para empresas en Guatemala y el extranjero.

**¬øEn qu√© puedo ayudarte hoy?**
‚Ä¢ Ver mis servicios y precios
‚Ä¢ Explorar mi portfolio de proyectos
‚Ä¢ Obtener una cotizaci√≥n personalizada
‚Ä¢ Informaci√≥n de contacto

¬øHay algo espec√≠fico que te interese?`
    };

    return fallbackResponses[intent] || fallbackResponses.general;
  }

  // M√©todo para verificar si el servicio est√° disponible
  isAvailable() {
    return this.isInitialized && this.groq !== null;
  }

  // M√©todo para obtener estad√≠sticas (opcional)
  getStats() {
    return {
      initialized: this.isInitialized,
      hasApiKey: !!import.meta.env.VITE_GROQ_API_KEY,
      quickResponsesCount: 8 // N√∫mero de respuestas r√°pidas definidas
    };
  }
}

// Singleton para usar en toda la aplicaci√≥n
const chatAI = new EklistaChatAI();

export default chatAI;